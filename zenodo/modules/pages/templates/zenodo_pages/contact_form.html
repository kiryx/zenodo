{#-
# This file is part of Zenodo.
# Copyright (C) 2017 CERN.
#
# Zenodo is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2 of the
# License, or (at your option) any later version.
#
# Zenodo is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Zenodo; if not, write to the
# Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,
# MA 02111-1307, USA.
#
# In applying this license, CERN does not
# waive the privileges and immunities granted to it by virtue of its status
# as an Intergovernmental Organization or submit itself to any jurisdiction.
-#}

{% extends "zenodo_theme/page.html" %}
{%- from "zenodo_pages/macros.html" import render_user_agent, render_form_field %}

{%- block page_body %}
{%- set user = current_user.is_authenticated and current_user %}
<div id="contact-page" class="container" >
  <div class="row">
    <div class="col-md-10">
      <div class="panel-body">
        <h2 class="header-form">Get help with Zenodo</h2>
        <div class="alert alert-info" role="alert">
          {%- if user %}
            Zenodo staff will get back to you by your Zenodo email <strong>{{ form.email.data }}</strong>.
          {%- else %}
            It is recommended to <strong><a href="{{url_for_security('login')}}">login</a></strong> first.
          {%- endif %}
        </div>
        <form method="POST" enctype="multipart/form-data" role="form">
          {{ form.csrf_token }}
          <div class="contact">
            <div class="row">
              <div class="col-md-2">
                <label for="{{form.name.label.field_id}}">{{ form.name.label.text }}</label>
              </div>
              <div class="col-md-4">
                {{ render_form_field(form.name) }}
              </div>
              {% if not user %}
                <div class="col-md-2">
                  <label for="{{form.email.label.field_id}}">{{ form.email.label.text }}</label>
                </div>
                <div class="col-md-4">
                  {{ render_form_field(form.email) }}
                </div>
              {% endif %}
            </div>
            <div class="row">
              <div class="col-md-2">
                <label for="{{form.issue_category.label.field_id}}">{{ form.issue_category.label.text }}</label>
              </div>
              <div class="col-md-4">
                {{ render_form_field(form.issue_category) }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"></div>
              <div class="col-md-10">
                <ul id="categories-tab" class="nav nav-tabs">
                  {%- for category in categories.values() %}
                    <li class="{%- if loop.index == 1 %} active in{%- endif %}">
                      <a name="{{ category.key }}" href="#{{ category.key }}"></a>
                    </li>
                  {%- endfor %}
                </ul>
                <div class="tab-content content-tab" style="min-height: 40px;">
                  {%- for category in categories.values() %}
                  <div id="{{ category.key }}" class="tab-pane fade {%- if loop.index == 1 %} active in {%- endif %}">
                    {{ category.description|safe }}
                  </div>
                  {%- endfor %}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-2">
                <label for="{{ form.subject.label.field_id }}">{{ form.subject.label.text }}</label>
              </div>
              <div class="col-md-10">
                {{ render_form_field(form.subject) }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2">
                <label for="{{form.description.label.field_id}}">{{ form.description.label.text }}</label>
              </div>
              <div class="col-md-10">
                {{ render_form_field(form.description) }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"></div>
              <div class="col-md-10">
                <div class="panel panel-default deposit-panel" align="center">
                  <h3>Drag files anywhere or click <a id="upload" onclick="return false">here</a> to upload</h3>
                  <p id="upload-info"></p>
                </div>
                {{ render_form_field(form.attachments) }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2">
                <label> Browser and system information</label>
              </div>
              <div class="col-md-8">
                <div class="row">
                      <div id="information">
                        {%- if uap.os %}
                        <div class="col-md-3"><b>Operating system</b></div>
                        <div class="col-md-9">{{ uap.os }}</div>
                        {%- endif %}

                        {%- if uap.browser %}
                        <div class="col-md-3"><b>Browser</b></div>
                        <div class="col-md-9">{{ uap.browser }}</div>
                        {%- endif %}

                        {%- if uap.device and uap.device != 'Other' %}
                        <div class="col-md-3"><b>Device</b></div>
                        <div class="col-md-9">{{ uap.device }}</div>
                        {%- endif %}
                      </div>
                </div>
              </div>
              <div class="col-md-2">
                <label for="{{form.include_os_browser.label.field_id}}">Send with message</label>
                <input class="form-control" id="{{ form.include_os_browser.id }}}" name="{{ form.include_os_browser.name }}" type="checkbox" value="y" checked>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                {{ render_form_field(form.recaptcha) }}
              </div>
              <div class="col-md-6">
                <button id="form_button" class="btn btn-block btn-success" type="submit">
                  Send Request
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{%- endblock page_body %}

{%- block javascript %}
{{super()}}

<script type="text/javascript">

var MAX_FILE_SIZE = {{ max_file_size|tojson }};

$(function () {
  $('#categories-tab').hide();
  $('#issue_category').on('change', function(e){
    $('#categories-tab li a[name="'+ $(this).val() + '"]').tab('show');
  });

  function format_size(bytes) {
    if (bytes == 0) {return '0.00 B';}
    var e = Math.floor(Math.log(bytes) / Math.log(1000));
    return (bytes / Math.pow(1000, e)).toFixed(2) + ' ' + ' KMGTP'.charAt(e) + 'B';
  };

  // Throws error if size is greater than max attachment size.
  function triggerCallback(e, callback) {
    var files;
    if(e.dataTransfer) {
      files = e.dataTransfer.files;
    } else if(e.target) {
      files = e.target.files;
    }
    callback.call(null, files);
  }

  // Setup file upload droparea
  function initFileDroparea(droparea, button, callback) {
    var attachments = document.getElementById('attachments');
    attachments.style.display = 'none';

    attachments.addEventListener('change', function(e) {
      triggerCallback(e, callback);
    });

    droparea.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
    });

    droparea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      e.stopPropagation();
    });

    droparea.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      triggerCallback(e, callback);
    });

    button.addEventListener('click', function() {
      attachments.value = null;
      attachments.click();
    });
  }

  function checkFilesSize(files) {
    if(files.length == 0) return;
    var filesInfo = '<strong>' + files.length + ' file(s) selected.</strong>';
    var totalSize = 0;
    for(var i = 0; i < files.length; i++){
      totalSize += files[i].size;
      filesInfo += '<br/><small>' + files[i].name + ' &nbsp&nbsp ' +
      format_size(files[i].size) + '</small>';
    }

    $('#upload-info').get(0).innerHTML = filesInfo;

    if(totalSize > MAX_FILE_SIZE) {
      $('.field-attachments').addClass('has-error');
      $('#error-attachments').innerHTML =
        'File size exceeded. Please add URLs to the files or make a smaller selection.';
      $('button#form_button').prop('disabled', true);
    } else {
      $('.field-attachments').removeClass('has-error');
      $('#error-attachments').innerHTML = '';
      $('button#form_button').prop('disabled', false);
    }
  }

  initFileDroparea(window.document.querySelector('html'),
                window.document.querySelector('#upload'), checkFilesSize);
});
</script>
{% endblock javascript %}
